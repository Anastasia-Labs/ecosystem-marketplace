import { Address, Machine, PAddress, PCurrencySymbol, PTokenName, compile, dataFromCbor, pData } from "@harmoniclabs/plu-ts";
import { makeMarketplaceContract } from "../marketplace";
import { toHex } from "@harmoniclabs/uint8array-utils";

test("buy", () => {

    // paymentAssetSym: Term<typeof PCurrencySymbol>,
    // paymentAssetName: Term<typeof PTokenName>,
    // owner: Term<typeof PAddress>,
    // oracleNftSym: Term<typeof PCurrencySymbol>,
    // oracleNftName: Term<typeof PTokenName>

    const ownerAddr = Address.fromString("addr_test1vrxhtzg5p7cwaxsnwejvwwvpmm82845wje643pdy800dceqcrytp5");
    console.log(
        JSON.stringify(
            ownerAddr.toData().toJson(),
            undefined,
            2
        )
    )

    console.log("making marketplace");
    const marketplace = makeMarketplaceContract(
        PCurrencySymbol.from("171163f05e4f30b6be3c22668c37978e7d508b84f83558e523133cdf"),
        PTokenName.from("74454d50"),
        PAddress.fromData(
            pData( ownerAddr.toData() )
        ),
        PCurrencySymbol.from("d0d1ce8ff888ea22f2b44a623dfa1e9b99348e86386f734793dd3371"),
        PTokenName.from(""),
    );

    const uplc = compile( marketplace )
    const deployedUplc = "0100003232323232323232323232323232323222253335734666666664444444464646464646464646666444464664a666ae68c005200010031533357346002900108020a999ab9a300148010401458dc39aab9d00135573c0026ea80100288cc09140104c8c8c8cc09ccdd7981300099ba548010cd5d019ba548000cd5d01ba8375a6ae84010cd5d01aba10033357406ae84008cd5d01aba13574400404a04a266ebcd5d08009aba13024302330243233302333322302422533357346ae8c00440944c94ccd5cd1802000899ba548000cd5d01802800815898019aba200235742002040466ebcd5d098130008010039311aba100132333332222232332533357346002900008018a999ab9a300148008401054ccd5cd1800a4008200a2a666ae68c0052006100616370e6aae74004d55cf0009baa005302400b0010012357420020024c60466ae84010d5d10009aba235573c6ea8030940108c8c8c8c8cc0a0cc0a0cc0a0cc0a0d5d19aba23323301e22533357346006004266ae80008004400409c8cdc39aab9d37546ae84c098d5d0981318129813000a400400e26ae8cd5d10048991980e119198159998131aba130283574200249408cdc79bae3574200200826603c46605866e3cdd71aab9d001375c605602226603e46605a66e3cdd71aab9d001375c646ae84d5d11aba235744002024266e1cdd69aab9e00148008dd59aab9e0013756604e002604e00200e6ae840244cc070cdc39998119980d119b8733301a0130123756604a604c604a604c00290010011311bad357426aae78dd518141813181298131aba1001480004cc01000404c4cc010cdc080180080619b833370400466604466032466e1cccc064048044dd59812181298121812800a40040024c46eb4d5d09aab9e3754604e604a6048604a6ae840052080897a375860440106eb4d5d0805111980c9191981419b8900433301901501437566048002266ebcd5d080080198120008021bac302100437586ae8400c4cc04cdc79bae357426aae78dd51aba1301d0040013323323016235740600400200297ac475c6eb0c8d5d09aba2357446ae88d5d11aba2357446ae88d5d1000800980d9aba1001301a003301800130180034891ccb17bc8735bbc759436d2ef8642c2129d4fdc4323154053bdec233590048810a4e61726e546f6b656e31004c0129d8799fd8799f581ccd7589140fb0ee9a137664c73981decea3d68e96755885a43bdedc64ffd87a80ff0048811cd0d1ce8ff888ea22f2b44a623dfa1e9b99348e86386f734793dd337100488100003002001149858888ccc0208520002225333573466e3cdd71aab9d002006133300b21480008894ccd5cd19b8f375c6aae740080204dd69aab9e0021300300137566aae780084c00c004004c88c028894ccd5cd1aba3001100b132533357346008002266e952000335740600a002022260066ae88008d5d080080311980210a50222330053004002130030012253335734004294400488cc00c84008888cc014008c00c004c0108888c8ccc018c010004c00c004008cc01000c0088894ccd55cf8008018998011aba100135744002400298103d87a800023230022330020020012300223300200200122232332533357346002900008018a999ab9a300148008401058dc39aab9d00135573c0026ea800c8d5d09aba2001235573c6ea8004dd8a4c46ae84d5d11aba2001225333573400400229401";

    console.log( toHex( uplc ) );

    expect( toHex( uplc ) ).toEqual( deployedUplc );

    const datumCbor = "d8799f1a01c9c380d8799fd8799f581c9b8cd93fd173fbdeae2b9556c7c31940910ad82e6fe5299c32737f0dffd8799fd8799fd8799f581cbd6b3cdf369c0faad153950ab77117a8f5ad29fa83913ec5fad61a4bffffffff581c28c380222b13ebd7ac76d751e54205179ea065f90acbc95ecafad129581b576f726c64204d6f62696c65205365656420546573742031303035ff";
    const rdmrCbor = "d87980";
    const ctxCbor = "d8799fd8799f9fd8799fd8799fd8799f58202ed5a8b63bd927e428815f79cf427e628e95291bccb16dacdc1ae59f95894163ff00ffd8799fd8799fd87a9f581c3e18ad5e7f52e9a57f76d28a58f6746983c67b6ed5ec84acb054434cffd87a80ffbf40bf401a001d43feff581c28c380222b13ebd7ac76d751e54205179ea065f90acbc95ecafad129bf581b576f726c64204d6f62696c6520536565642054657374203130303501ffffd87b9fd8799f1a01c9c380d8799fd8799f581c9b8cd93fd173fbdeae2b9556c7c31940910ad82e6fe5299c32737f0dffd8799fd8799fd8799f581cbd6b3cdf369c0faad153950ab77117a8f5ad29fa83913ec5fad61a4bffffffff581c28c380222b13ebd7ac76d751e54205179ea065f90acbc95ecafad129581b576f726c64204d6f62696c65205365656420546573742031303035ffffd87a80ffffd8799fd8799fd8799f5820a16a5f31f95712e55c19552460154806eafd1ac76a584fb4d40a19f510f392a8ff00ffd8799fd8799fd8799f581ccd7589140fb0ee9a137664c73981decea3d68e96755885a43bdedc64ffd87a80ffbf40bf401a05f5e100ff581c171163f05e4f30b6be3c22668c37978e7d508b84f83558e523133cdfbf4474454d501a05f5e100ffffd87980d87a80ffffff9fd8799fd8799fd8799f5820466a7a03b39ec25ef992a25710901fdbe89cae96304faceb81c1153885b0f71dff01ffd8799fd8799fd87a9f581cbd7971cda86f40a609b73985d45b68d398b502baabf5c90a4b21c996ffd87a80ffbf40bf401a001e8480ff581cd0d1ce8ff888ea22f2b44a623dfa1e9b99348e86386f734793dd3371bf4001ffffd87b9f1961a8ffd87a80ffffd8799fd8799fd8799f58209023d174eb853816c986d0653fef94cb8d98fa091130810de090b87cf4c6bbb3ff00ffd8799fd8799fd87a9f581c3e18ad5e7f52e9a57f76d28a58f6746983c67b6ed5ec84acb054434cffd87a80ffbf40bf401a00989680ffffd87b9f40ffd8799f581c3e18ad5e7f52e9a57f76d28a58f6746983c67b6ed5ec84acb054434cffffffff9fd8799fd8799fd8799f581ccd7589140fb0ee9a137664c73981decea3d68e96755885a43bdedc64ffd87a80ffbf40bf401a001e8480ff581c28c380222b13ebd7ac76d751e54205179ea065f90acbc95ecafad129bf581b576f726c64204d6f62696c6520536565642054657374203130303501ffffd87980d87a80ffd8799fd8799fd8799f581ccd7589140fb0ee9a137664c73981decea3d68e96755885a43bdedc64ffd87a80ffbf40bf401a001e8480ff581c171163f05e4f30b6be3c22668c37978e7d508b84f83558e523133cdfbf4474454d501a000b71b0ffffd87980d87a80ffd8799fd8799fd8799f581c9b8cd93fd173fbdeae2b9556c7c31940910ad82e6fe5299c32737f0dffd8799fd8799fd8799f581cbd6b3cdf369c0faad153950ab77117a8f5ad29fa83913ec5fad61a4bffffffffbf40bf401a001e8480ff581c171163f05e4f30b6be3c22668c37978e7d508b84f83558e523133cdfbf4474454d501a01be51d0ffffd87980d87a80ffd8799fd8799fd8799f581ccd7589140fb0ee9a137664c73981decea3d68e96755885a43bdedc64ffd87a80ffbf40bf401a05b493b5ff581c171163f05e4f30b6be3c22668c37978e7d508b84f83558e523133cdfbf4474454d501a042c1d80ffffd87980d87a80ffffbf40bf401a000303c9ffffbf40bf4000ffff80a0d8799fd8799fd87980d87980ffd8799fd87b80d87980ffff9f581ccd7589140fb0ee9a137664c73981decea3d68e96755885a43bdedc64ffbfd87a9fd8799fd8799f58202ed5a8b63bd927e428815f79cf427e628e95291bccb16dacdc1ae59f95894163ff00ffffd87980ffa058202868d1c021ce8cfbea2e919c9901fe0116d5afaeadce56763858b9eaaa7ec022ffd87a9fd8799fd8799f58202ed5a8b63bd927e428815f79cf427e628e95291bccb16dacdc1ae59f95894163ff00ffffff";

    console.log("applying marketplace");
    const applied = (
        marketplace
        .$( pData( dataFromCbor( datumCbor ) ) )
        .$( pData( dataFromCbor( rdmrCbor ) ) )
        .$( pData( dataFromCbor( ctxCbor ) ) )
    )

    console.log("evaluating");
    const result = Machine.evalSimple( applied );

    console.log( result );
})